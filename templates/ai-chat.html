<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroMedia - AI Chatbot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/ai-chat.css">
</head>
<body>

    <div class="sidebar-handle" id="sidebar-btn"><i class="fa-solid fa-chevron-right"></i></div>

    <nav class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fa-solid fa-bolt" style="color: var(--primary-green);"></i>
            <div>
                <span>NeuroMedia</span>
                <span class="logo-subtitle">Education Media Platform</span>
            </div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="./dashboard.html" class="nav-link"><i class="fa-solid fa-house"></i><span>Dashboard</span></a></li>
            <li class="nav-item"><a href="./media.html" class="nav-link"><i class="fa-solid fa-photo-film"></i><span>Media Library</span></a></li>
            <li class="nav-item"><a href="./media-chat.html" class="nav-link"><i class="fa-regular fa-comments"></i><span>AI Media Chat</span></a></li>
            <li class="nav-item"><a href="./ai-video.html" class="nav-link "><i class="fa-solid fa-scissors"></i><span>AI Video Trimmer</span></a></li>
            <li class="nav-item"><a href="./ai-chat.html" class="nav-link active"><i class="fa-solid fa-robot"></i><span>AI Chatbot</span></a></li>
            <li class="nav-item"><a href="./computer-v.html" class="nav-link"><i class="fa-regular fa-eye"></i><span>Computer Vision</span></a></li>
            <li class="nav-item"><a href="./world-skils.html" class="nav-link"><i class="fa-solid fa-trophy"></i><span>WorldSkills</span></a></li>
        </ul>
        <div class="user-profile">
            <img src="https://i.pravatar.cc/100?img=33" alt="User" class="avatar">
            <div class="user-info"><h4>John Doe</h4><p>Student</p></div>
        </div>
    </nav>

    <main class="main-content">
        <header class="page-header">
            <h2>AI Chatbot</h2>
            <p>Ask me anything about the college</p>
        </header>

        <div class="avatar-stage">
            <div id="mascot" class="robot-head">
                <div class="eyes-container">
                    <div class="eye"></div><div class="eye"></div>
                </div>
                <div class="loader-ring"></div>
                <div class="voice-wave">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
            </div>
        </div>

        <div class="chat-box" id="chat-box">
            <div class="msg ai">–ü—Ä–∏–≤–µ—Ç! –Ø –ò–Ω—Ç–∏. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? ü§ñ</div>
        </div>

        <div class="prompts-scroll">
            <button class="prompt-btn" onclick="sendPrompt(this)">–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∫–æ–ª–ª–µ–¥–∂</button>
            <button class="prompt-btn" onclick="sendPrompt(this)">–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</button>
            <button class="prompt-btn" onclick="sendPrompt(this)">–°—Ç–æ–∏–º–æ—Å—Ç—å</button>
            <button class="prompt-btn" onclick="sendPrompt(this)">–ö–∞–∫ –ø–æ—Å—Ç—É–ø–∏—Ç—å?</button>
        </div>

        <div class="input-wrapper">
            <input type="text" id="inp" class="input-field" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..." onkeypress="if(event.key==='Enter') send()">
            <button class="send-btn" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </main>

<script>
    const SERVER_URL = "http://127.0.0.1:8000";
    const mascotDiv = document.getElementById('mascot');
    const chatBox = document.getElementById('chat-box');
    const inp = document.getElementById('inp');
    const sidebar = document.getElementById("sidebar");
    const sidebarBtn = document.getElementById("sidebar-btn");
    const btnIcon = sidebarBtn.querySelector("i");

    // –õ–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
    sidebarBtn.addEventListener("click", () => {
        sidebar.classList.toggle("open");
        // –ú–µ–Ω—è—Ç—å —Å—Ç—Ä–µ–ª–æ—á–∫—É
        if(sidebar.classList.contains("open")) {
            btnIcon.classList.replace("fa-chevron-right", "fa-chevron-left");
        } else {
            btnIcon.classList.replace("fa-chevron-left", "fa-chevron-right");
        }
    });

    // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ (–Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º)
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
            if (!sidebar.contains(e.target) && !sidebarBtn.contains(e.target)) {
                sidebar.classList.remove("open");
                btnIcon.classList.replace("fa-chevron-left", "fa-chevron-right");
            }
        }
    });

    function setMascotState(state) {
        mascotDiv.classList.remove('state-thinking', 'state-speaking');
        if (state === 'thinking') mascotDiv.classList.add('state-thinking');
        if (state === 'speaking') mascotDiv.classList.add('state-speaking');
    }

    async function send() {
        const text = inp.value.trim();
        if (!text) return;
        addMsg(text, 'user');
        inp.value = '';
        processRequest(text);
    }

    function sendPrompt(btn) {
        const text = btn.innerText;
        addMsg(text, 'user');
        processRequest(text);
    }

    async function processRequest(text) {
        setMascotState('thinking');
        try {
            const respText = await fetch(`${SERVER_URL}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            if (!respText.ok) throw new Error("Server error");
            const data = await respText.json();
            addMsg(data.text, 'ai');
            await streamAudio(data.text);
        } catch (e) {
            console.error(e);
            addMsg("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...", 'ai');
            setMascotState('idle');
        }
    }

    async function streamAudio(text) {
        try {
            const respAudio = await fetch(`${SERVER_URL}/tts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            const blob = await respAudio.blob();
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            setMascotState('speaking');
            audio.onended = () => setMascotState('idle');
            audio.play();
        } catch (e) {
            console.error(e);
            setMascotState('idle');
        }
    }

    function addMsg(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>