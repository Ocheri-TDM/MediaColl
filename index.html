<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTC Bot</title>
    <style>
        /* --- –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò --- */
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .chat-card { width: 360px; height: 600px; background: white; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,85,255,0.15); overflow: hidden; display: flex; flex-direction: column; }
        
        /* --- –û–ë–õ–ê–°–¢–¨ –ú–ê–°–ö–û–¢–ê --- */
        .header { 
            background: linear-gradient(135deg, #0066ff, #00ccff); 
            padding: 30px 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: white;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            box-shadow: 0 5px 15px rgba(0,100,255,0.3);
            position: relative;
            z-index: 10;
        }

        /* –†–û–ë–û–¢ (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–æ–ª–æ–≤—ã) */
        .robot-head {
            width: 80px;
            height: 65px;
            background: white;
            border-radius: 18px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.1);
            animation: float 4s ease-in-out infinite; /* –õ–µ–≤–∏—Ç–∞—Ü–∏—è */
            margin-bottom: 15px;
        }

        /* –ê–ù–¢–ï–ù–ù–ê */
        .robot-head::before {
            content: ''; position: absolute; top: -12px; width: 4px; height: 12px; background: rgba(255,255,255,0.6); border-radius: 4px;
        }
        .robot-head::after {
            content: ''; position: absolute; top: -18px; width: 8px; height: 8px; background: #ff0055; border-radius: 50%; box-shadow: 0 0 10px #ff0055;
        }

        /* --- –°–û–°–¢–û–Ø–ù–ò–ï 1: –ì–õ–ê–ó–ê (IDLE) --- */
        .eyes-container {
            display: flex;
            gap: 14px;
            transition: opacity 0.3s;
        }
        .eye {
            width: 12px;
            height: 16px;
            background: #0055ff;
            border-radius: 6px;
            animation: blink 4s infinite;
        }

        /* --- –°–û–°–¢–û–Ø–ù–ò–ï 2: –ó–ê–ì–†–£–ó–ö–ê (THINKING) --- */
        .loader-ring {
            width: 30px;
            height: 30px;
            border: 4px solid #e1e1e1;
            border-top: 4px solid #0055ff;
            border-radius: 50%;
            position: absolute;
            opacity: 0; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            transform: scale(0.5);
            transition: all 0.3s;
        }

        /* --- –°–û–°–¢–û–Ø–ù–ò–ï 3: –ì–û–õ–û–° (SPEAKING) --- */
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 20px;
            position: absolute;
            opacity: 0; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            transform: scale(0.5);
            transition: all 0.3s;
        }
        .bar {
            width: 6px;
            background: #0055ff;
            border-radius: 4px;
            height: 6px;
        }

        /* --- –ö–õ–ê–°–°–´ –°–û–°–¢–û–Ø–ù–ò–ô (JS –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∏—Ö) --- */
        
        /* –î—É–º–∞–µ—Ç */
        .state-thinking .eyes-container { opacity: 0; }
        .state-thinking .loader-ring { opacity: 1; transform: scale(1); animation: spin 1s linear infinite; }
        
        /* –ì–æ–≤–æ—Ä–∏—Ç */
        .state-speaking .eyes-container { opacity: 0; }
        .state-speaking .voice-wave { opacity: 1; transform: scale(1); }
        .state-speaking .bar { animation: sound 0.6s ease-in-out infinite; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –≤–æ–ª–Ω—ã (—Ä–∞–∑–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞–ª–æ—á–∫–∏) */
        .bar:nth-child(1) { animation-delay: 0.0s; }
        .bar:nth-child(2) { animation-delay: 0.1s; }
        .bar:nth-child(3) { animation-delay: 0.2s; }
        .bar:nth-child(4) { animation-delay: 0.1s; }
        .bar:nth-child(5) { animation-delay: 0.0s; }

        /* --- KEYFRAMES (–î–≤–∏–∂–µ–Ω–∏—è) --- */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes blink { 0%, 48%, 52%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.1); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes sound { 
            0%, 100% { height: 6px; } 
            50% { height: 24px; background: #ff0055; } /* –ü—Ä–∏ –ø–∏–∫–µ —Ü–≤–µ—Ç –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π */
        }

        /* –ß–ê–¢ –ò –í–í–û–î */
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: #f9fcff; }
        .msg { padding: 12px 16px; border-radius: 16px; max-width: 80%; font-size: 14px; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user { background: #0066ff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai { background: white; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #eee; }
        
        .input-area { padding: 20px; background: white; display: flex; gap: 10px; border-top: 1px solid #eee; }
        input { flex: 1; padding: 12px 15px; border-radius: 25px; border: 1px solid #ddd; outline: none; transition: 0.3s; background: #f4f4f4; }
        input:focus { background: white; border-color: #0066ff; box-shadow: 0 0 0 3px rgba(0,102,255,0.1); }
        button { padding: 12px 24px; border-radius: 25px; border: none; background: #0066ff; color: white; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { background: #0052cc; transform: scale(1.05); }
        button:disabled { background: #ccc; transform: scale(1); cursor: wait; }
    </style>
</head>
<body>

<div class="chat-card">
    <div class="header">
        <div id="mascot" class="robot-head">
            
            <div class="eyes-container">
                <div class="eye"></div>
                <div class="eye"></div>
            </div>

            <div class="loader-ring"></div>

            <div class="voice-wave">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>

        </div>
        <h3 style="margin:0; font-weight: 600; letter-spacing: 0.5px;">INTC AI</h3>
        <p style="margin:5px 0 0 0; font-size: 12px; opacity: 0.8;">–¢–≤–æ–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫</p>
    </div>
    
    <div class="chat-box" id="chat-box">
        <div class="msg ai">–ü—Ä–∏–≤–µ—Ç! –Ø –ò–Ω—Ç–∏. –ì–æ—Ç–æ–≤ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ –∫–æ–ª–ª–µ–¥–∂! üëã</div>
    </div>
    
    <div class="input-area">
        <input type="text" id="inp" placeholder="–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å..." onkeypress="if(event.key==='Enter') send()">
        <button onclick="send()" id="btn">Go</button>
    </div>
</div>

<script>
    const SERVER_URL = "http://127.0.0.1:8000"; 
    
    const mascotDiv = document.getElementById('mascot');
    const btn = document.getElementById('btn');
    const inp = document.getElementById('inp');

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
    function setMascotState(state) {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã
        mascotDiv.classList.remove('state-thinking', 'state-speaking');
        
        if (state === 'thinking') {
            mascotDiv.classList.add('state-thinking');
        } else if (state === 'speaking') {
            mascotDiv.classList.add('state-speaking');
        }
        // –ï—Å–ª–∏ state == 'idle', –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã, –∏ CSS –ø–æ–∫–∞–∂–µ—Ç –≥–ª–∞–∑–∞
    }

    async function send() {
        const text = inp.value.trim();
        if (!text) return;

        // UI: –°–æ–æ–±—â–µ–Ω–∏–µ —é–∑–µ—Ä–∞
        addMsg(text, 'user');
        inp.value = '';
        btn.disabled = true;
        
        // 1. –í–ö–õ–Æ–ß–ê–ï–ú –ê–ù–ò–ú–ê–¶–ò–Æ "–ó–ê–ì–†–£–ó–ö–ê" (–ö–æ–ª—å—Ü–æ)
        setMascotState('thinking');

        try {
            // –ó–∞–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–∞
            const respText = await fetch(`${SERVER_URL}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await respText.json();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
            addMsg(data.text, 'ai');

            // 2. –ó–ê–ü–£–°–ö–ê–ï–ú –ì–û–õ–û–° –ò –ê–ù–ò–ú–ê–¶–ò–Æ "–í–û–õ–ù–ê"
            await streamAudio(data.text);

        } catch (e) {
            console.error(e);
            addMsg("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...", 'ai');
            setMascotState('idle');
            btn.disabled = false;
        }
    }

    async function streamAudio(text) {
        try {
            // –ó–∞–ø—Ä–æ—Å –∞—É–¥–∏–æ
            const respAudio = await fetch(`${SERVER_URL}/tts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });

            const blob = await respAudio.blob();
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);

            // –í–ö–õ–Æ–ß–ê–ï–ú –ê–ù–ò–ú–ê–¶–ò–Æ "–ì–û–í–û–†–ò–¢" (–≠–∫–≤–∞–ª–∞–π–∑–µ—Ä)
            setMascotState('speaking');

            audio.onended = () => {
                // –ö–æ–≥–¥–∞ –∑–∞–º–æ–ª—á–∞–ª -> –û–ë–´–ß–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (–ì–ª–∞–∑–∞)
                setMascotState('idle');
                btn.disabled = false;
            };
            
            audio.play();
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ TTS:", e);
            setMascotState('idle');
            btn.disabled = false;
        }
    }

    function addMsg(text, type) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }
</script>

</body>
</html>